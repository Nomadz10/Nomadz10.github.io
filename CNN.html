<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Image Convolution</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <style>
    body {
      overflow-x: hidden;
      background-color: #121212;
    }
    .card {
      border: none;
      color: #E0E0E0;
      background: #242424;
      box-shadow: 0 10px 32px 0 #1DB9C3;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 10px;
    }
    .navbar-custom, .footer {
      background-color: #7c8498;
      color: #000000;

    }
    .banner{
      background-color: #7c8498;
      color: #000000;
    }
    .navbar-brand, .link-secondary {
      color: #c54949;
    }
    .controls-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }
    .select {
      width: 200px;
      padding-left: 0px;
    }
    .image-container, .output-container {
      color: #1DB9C3;
      flex: 1;
    }
    #convolution-matrix input, #iterations {
      width: 3em;
      padding-left: 0px;
      text-align: center;
      -webkit-appearance: checkbox;
      margin: 1px;
    }
    #convolution-matrix input::-webkit-outer-spin-button,
    #convolution-matrix input::-webkit-inner-spin-button {
      display: none;
    }
    .form-control-file {
      width: auto;
    }
    @media (min-width: 786px) {
      .form-control-file {
        width: 300px;
      }
    }

    .tab{
      background-color: #121212;
    }
    /* Added styles */
    .btn-primary{
      background-color: #1DB9C3;
    }
    .matrix-col .t-div { /* Targeting the specific divs */
      padding: 5px; /* Removes padding */
    }
    .row.t-row {
      margin-right: 0px; /* Removes the right margin of the row */
      margin-left: 0px; /* Removes the left margin of the row */
    }
    .matrix-col .t-div input {
      border-radius: 10px;
    }
  </style>
</head>
<body>
<header data-bs-theme="dark">
  <nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Muppalla Projects</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Convolution Tool</a></li>
        </ul>
      </div>
    </div>
  </nav>
</header>
<main>
  <div class="banner p-0 mb-4">
    <div class="container-fluid py-1">
      <h1 class="dispaly-5 fw-bold">Image Convolution Tool</h1>
    </div>
  </div>
  <div class="controls-container">
    <div class="container-fluid p-5 overflow-hidden">
      <div  class="row justify-content-center">
        <div class="col-md-3">
          <div class="card shadow p-1 mb-5 rounded h-100">
            <div class="card-body">
              <h5 class="card-title">Tool Features</h5>
              <p class="card-text">
                This tool will take an image of any size and apply a user
                selected convolution matrix to transform the image. There are
                many preset convolution options such as sharpen, blur, edge
                detection, etc. The user can also input their own custom
                values into the convolution matrix as well. The user can also
                select the number of times they would like to apply a
                convolution filter. After convolving the user can also save
                the resulting image.
              </p>
            </div>
          </div>
        </div>
          <div class="col-md-4">
            <div class="card shadow p-1 mb-5 rounded">
              <div class="card-body">
                <h5 class="card-title">Behind the Scenes</h5>
                <p class="card-text">
                  When a user uploads an image, the image is immediately
                  converted into grayscale. Each pixel in the original image has
                  three values: R (red), G (green), and B (blue). 30% of the red
                  value, 59% of the green value and 11% of the blue value are
                  added together to create a new pixel value that will fall
                  between 0 and 255. This new value represents the shade of gray
                  in our grayscale image. The image is then 'padded' by 0s in
                  order to make sure that the convolution operations do not
                  reduce the size of the image over time. Due to the nature of
                  how the convolution filter multiples with the image, the
                  border rows and columns are lost after every convolution.
                  Padding creates an artificial black border around the image
                  that prevents any of the actual image from being lost. This
                  padding is added before every convolution. Once the user
                  selects their convolution matrix values, this matrix is then
                  multiplied by every 3x3 section of our grayscale image. The
                  sum of the values in the resulting matrix will become the new
                  convolved pixel value. This is done throughout the image by
                  sliding the filter one column to the right every time. When
                  the end of a column is reached, the filter will go back to the
                  first column and slide down one row. This is done until all
                  rows are complete. Once the resulting image matrix is
                  generated, the program will check to see if more iterations
                  were requested, if so the process will repeat by taking the
                  newly convolved image as the input until all iterations are
                  complete
                </p>
              </div>
            </div>
        </div>
        <div class="col-md-4">
          <div class="container">
            <div class="card table-card">
              <div class="card-body" id="convolution-matrix">
                <h2 class="card-title text-center">Convolution Matrix</h2>
                <div class="row matrix-row justify-content-center">
                  <div class="col-md-8 matrix-col">
                    <div class="row t-row justify-content-center">
                      <div class="col t-div">
                        <input
                                type="number"
                                class="form-control"
                                id="matrix-0-0"
                        />
                      </div>
                      <div class="col t-div">
                        <input
                                type="number"
                                class="form-control"
                                id="matrix-0-1"
                        />
                      </div>
                      <div class="col t-div">
                        <input
                                type="number"
                                class="form-control"
                                id="matrix-0-2"
                        />
                      </div>
                    </div>
                    <div class="row t-row justify-content-center">
                      <div class="col t-div">
                        <input
                                type="number"
                                class="form-control"
                                id="matrix-1-0"
                        />
                      </div>
                      <div class="col t-div">
                        <input
                                type="number"
                                class="form-control"
                                id="matrix-1-1"
                        />
                      </div>
                      <div class="col t-div">
                        <input
                                type="number"
                                class="form-control"
                                id="matrix-1-2"
                        />
                      </div>
                    </div>
                    <div class="row t-row justify-content-center">
                      <div class="col t-div">
                        <input
                                type="number"
                                class="form-control"
                                id="matrix-2-0"
                        />
                      </div>
                      <div class="col t-div">
                        <input
                                type="number"
                                class="form-control"
                                id="matrix-2-1"
                        />
                      </div>
                      <div class="col t-div">
                        <input
                                type="number"
                                class="form-control"
                                id="matrix-2-2"
                        />
                      </div>
                    </div>
                  </div>
                </div>
                <br/>
                <div class="row justify-content-center">
                  <div class="col-md-10 select">
                    <!-- <label for="options">Choose an option:</label> -->
                    <select
                            class="form-select form-select-sm"
                            id="options"
                            name="options"
                            aria-label=".form-select-sm example"
                    >
                      <option disabled selected data-hidden="true">
                        Select an option
                      </option>
                      <option value="option1">
                        Identity (just convert to B/W)
                      </option>
                      <option value="option2">Sharpen</option>
                      <option value="option3">Mean Blur</option>
                      <option value="option4">Edge Detection</option>
                      <option value="option5">Gaussian Blur</option>
                      <option value="option6">Horizontal Sobel</option>
                      <option value="option7">Vertical Sobel</option>
                    </select>
                  </div>
                </div>
              </div>
              <hr />
              <div class="card-body">
                <label for="iterations">Number of Iterations:</label>
                <input type="number" id="iterations" value="1" />
                <br />
                <br />
                <button class="btn btn-primary" id="convolve-button">
                  Grayscale Convolve
                </button>
                <button class="btn btn-primary" id="colorize">
                  Color Convolve
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row justify-content-center">

        <div class="image-container">
          <br/>
          <label class="form-label">Upload an image</label>
          <input
                  class="form-control form-control-sm form-control-file"
                  id="input-image"
                  type="file"
          />
        </div>
        <div class="col-2">
          <br/>
          <br/>
          <div class="save">
            <button type="button" class="btn btn-primary" id="save-button">
              Save Image
            </button>
          </div>
        </div>
      </div>
      <div class="row justify-content-center">
        <div class="col-sm">
          <img id="uploaded-image" style="display: none" />
          <canvas id="initial-canvas"></canvas>
        </div>
        <div class="col-sm">
          <div class="output-container">
            <div id="output-canvas"></div>
          </div>
          <div class="row align-items-end">
            <div class="col"></div>
            <div class="col"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</main>
<div class="footer container-fluid p-3">
  <!-- Footer Content -->
  <!-- Place for Footer content including contact information and external resources -->
</div>
<!-- Bootstrap JS, FontAwesome, and Custom JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="https://kit.fontawesome.com/c5b250e284.js" crossorigin="anonymous"></script>
<script>
  const matrixValues = {
    option1: [
      [0, 0, 0],
      [0, 1, 0],
      [0, 0, 0],
    ],
    option2: [
      [0, -1, 0],
      [-1, 5, -1],
      [0, -1, 0],
    ],
    option3: [
      [1 / 9, 1 / 9, 1 / 9],
      [1 / 9, 1 / 9, 1 / 9],
      [1 / 9, 1 / 9, 1 / 9],
    ],
    option4: [
      [-1, -1, -1],
      [-1, 8, -1],
      [-1, -1, -1],
    ],
    option5: [
      [1 / 16, 2 / 16, 1 / 16],
      [2 / 16, 4 / 16, 2 / 16],
      [1 / 16, 2 / 16, 1 / 16],
    ],
    option6: [
      [-1, -2, -1],
      [0, 0, 0],
      [1, 2, 1],
    ],
    option7: [
      [-1, 0, 1],
      [-2, 0, 2],
      [-1, 0, 1],
    ],
  };

  const selectElement = document.getElementById("options");
  const matrixInputs = document.querySelectorAll(
          "#convolution-matrix input"
  );

  selectElement.addEventListener("change", function () {
    const selectedOption = this.value;
    if (selectedOption in matrixValues) {
      const selectedMatrix = matrixValues[selectedOption];
      for (let i = 0; i < selectedMatrix.length; i++) {
        for (let j = 0; j < selectedMatrix[i].length; j++) {
          const inputElement = document.getElementById(`matrix-${i}-${j}`);
          inputElement.value = selectedMatrix[i][j];
        }
      }
    } else {
      for (let i = 0; i < matrixInputs.length; i++) {
        matrixInputs[i].value = "";
      }
    }
  });

  const iterationsInput = document.getElementById("iterations");
  const greyconvolve = document.getElementById("convolve-button");
  const initialCanvas = document.getElementById("initial-canvas");
  const colorconvolve = document.getElementById("colorize")
  let inputImageData;

  function convertToGrayscale(imageData) {
    let grayscaleMatrix = [];
    for (let i = 0; i < imageData.height; i++) {
      grayscaleMatrix[i] = [];
      for (let j = 0; j < imageData.width; j++) {
        let index = i * 4 * imageData.width + j * 4;
        let r = imageData.data[index];
        let g = imageData.data[index + 1];
        let b = imageData.data[index + 2];
        grayscaleMatrix[i][j] = 0.3 * r + 0.59 * g + 0.11 * b;
      }
    }
    return grayscaleMatrix;
  }

  function convolution2D(largeMatrix, smallMatrix) {
    let result = [];
    for (let i = 0; i < largeMatrix.length - 2; i++) {
      result[i] = [];
      for (let j = 0; j < largeMatrix[i].length - 2; j++) {
        let sum = 0;
        for (let k = 0; k < 3; k++) {
          for (let l = 0; l < 3; l++) {
            sum += largeMatrix[i + k][j + l] * smallMatrix[k][l];
          }
        }
        result[i][j] = sum;
      }
    }
    return result;
  }
  function convolution3D(largeMatrix, smallMatrix) {
    let result = [];
    for (let i = 0; i < largeMatrix.length - 2; i++) {
      result[i] = [];
      for (let j = 0; j < largeMatrix[i].length - 2; j++) {
        result[i][j] = [];
        for (let z = 0; z < largeMatrix[i][j].length; z++) {
          let sum = 0;
          for (let k = 0; k < 3; k++) {
            for (let l = 0; l < 3; l++) {
              sum += largeMatrix[i + k][j + l][z] * smallMatrix[k][l];
            }
          }
          result[i][j][z] = sum;
        }
      }
    }
    return result;
  }
  const inputImage = document.getElementById("input-image");
  const canvas = document.createElement("canvas");
  const w = 695;
  const h = 800;
  inputImage.addEventListener("change", function (event) {
    let canvasDiv = document.getElementById("output-canvas");
    canvasDiv.innerHTML = "";
    let reader = new FileReader();
    reader.onload = function (event) {
      let image = new Image();
      image.onload = function () {
        initialCanvas.width = image.width;
        initialCanvas.height = image.height;
        if (initialCanvas.width > w) {
          initialCanvas.height *= w / initialCanvas.width;
          initialCanvas.width = w;
        } else {
          if (initialCanvas.height > h) {
            initialCanvas.width *= h / initialCanvas.height;
            initialCanvas.height = h;
          }
        }
        canvas.width = initialCanvas.width;
        canvas.height = initialCanvas.height;
        let context = initialCanvas.getContext("2d");
        context.drawImage(
                image,
                0,
                0,
                initialCanvas.width,
                initialCanvas.height
        );
        inputImageData = context.getImageData(
                0,
                0,
                initialCanvas.width,
                initialCanvas.height
        );
      };
      image.src = event.target.result;
    };
    reader.readAsDataURL(event.target.files[0]);
  });


  colorconvolve.addEventListener("click", function(event) {
    event.preventDefault();
    if (!inputImageData) {
      return alert("Please select an image.");
    }
    //NUMBER OF ITERATIONS
    let iterations = parseInt(iterationsInput.value);
    // Define the dimensions of the image
    const width = inputImageData.width;
    const height = inputImageData.height;

// Create a 3D array to store the pixel data
    let finMatrix = new Array(height);

// Iterate over each row of pixels
    for (let y = 0; y < height; y++) {
      // Create an array to store the pixels in this row
      finMatrix[y] = new Array(width);

      // Iterate over each pixel in the row
      for (let x = 0; x < width; x++) {
        // Calculate the index of the pixel in the image data array
        const index = (y * width + x) * 4; // Each pixel consists of 4 values (RGBA)

        // Extract the color channels (RGB) of the pixel
        const r = inputImageData.data[index];
        const g = inputImageData.data[index + 1];
        const b = inputImageData.data[index + 2];

        // Store the RGB values in the finMatrix
        finMatrix[y][x] = [r, g, b];
      }
    }
    //DEFAULT CONV MATRIX
    let convMatrix = [
      [-1, -1, -1],
      [-1, 2, -1],
      [-1, -1, -1],
    ];
    //GETTING THE CONVOLUTION MATRIX
    convMatrix[0][0] = parseFloat(
            document.getElementById("matrix-0-0").value
    );
    convMatrix[0][1] = parseFloat(
            document.getElementById("matrix-0-1").value
    );
    convMatrix[0][2] = parseFloat(
            document.getElementById("matrix-0-2").value
    );
    convMatrix[1][0] = parseFloat(
            document.getElementById("matrix-1-0").value
    );
    convMatrix[1][1] = parseFloat(
            document.getElementById("matrix-1-1").value
    );
    convMatrix[1][2] = parseFloat(
            document.getElementById("matrix-1-2").value
    );
    convMatrix[2][0] = parseFloat(
            document.getElementById("matrix-2-0").value
    );
    convMatrix[2][1] = parseFloat(
            document.getElementById("matrix-2-1").value
    );
    convMatrix[2][2] = parseFloat(
            document.getElementById("matrix-2-2").value
    );
    //IF EMPTY MATRIX IS ENTERED THIS GIVES IDENTITY
    if (Number.isNaN(convMatrix[0][0])) {
      convMatrix = [
        [0, 0, 0],
        [0, 1, 0],
        [0, 0, 0],
      ];
    }
    function addPadding(originalMatrix) {
      // Original dimensions
      const originalHeight = originalMatrix.length;
      const originalWidth = originalMatrix[0].length;

      // New dimensions including padding
      const paddedHeight = originalHeight + 2;
      const paddedWidth = originalWidth + 2;

      // Create a new matrix for the padded image
      let paddedMatrix = new Array(paddedHeight);

      for (let y = 0; y < paddedHeight; y++) {
        paddedMatrix[y] = new Array(paddedWidth);

        for (let x = 0; x < paddedWidth; x++) {
          // Check if the current pixel is part of the original image or the padding
          if (y > 0 && y < paddedHeight - 1 && x > 0 && x < paddedWidth - 1) {
            // This is part of the original image, so copy the pixel over
            paddedMatrix[y][x] = originalMatrix[y - 1][x - 1];
          } else {
            // This is part of the padding
            paddedMatrix[y][x] = [0, 0, 0];
          }
        }
      }

      return paddedMatrix;
    }

    //ACTUAL CONVOLUTIONS HAPPENING
    for (let i = 0; i < iterations; i++) {
      finMatrix = addPadding(finMatrix);
      finMatrix = convolution3D(finMatrix, convMatrix);
    }

// Rendering the result on canvas
    let canvas = document.createElement("canvas");
    let canvasDiv = document.getElementById("output-canvas");
    canvasDiv.innerHTML = "";
    canvas.width = finMatrix[0].length;
    canvas.height = finMatrix.length;
    canvasDiv.appendChild(canvas);

    let context = canvas.getContext("2d");
    let finImgData = context.createImageData(canvas.width, canvas.height);

    for (let y = 0; y < finMatrix.length; y++) {
      for (let x = 0; x < finMatrix[0].length; x++) {
        const index = (y * finMatrix[0].length + x) * 4;
        finImgData.data[index] = finMatrix[y][x][0]; // Red channel
        finImgData.data[index + 1] = finMatrix[y][x][1]; // Green channel
        finImgData.data[index + 2] = finMatrix[y][x][2]; // Blue channel
        finImgData.data[index + 3] = 255; // Alpha channel
      }
    }
    context.putImageData(finImgData, 0, 0);

  });


  greyconvolve.addEventListener("click", function (event) {
    event.preventDefault();
    if (!inputImageData) {
      return alert("Please select an image.");
    }

    //NUMBER OF ITERATIONS
    let iterations = parseInt(iterationsInput.value);
    //GETTING GRAYSCALED MATRIX
    let finMatrix = convertToGrayscale(inputImageData);

    //DEFAULT CONV MATRIX
    let convMatrix = [
      [-1, -1, -1],
      [-1, 2, -1],
      [-1, -1, -1],
    ];
    //GETTING THE CONVOLUTION MATRIX
    convMatrix[0][0] = parseFloat(
            document.getElementById("matrix-0-0").value
    );
    convMatrix[0][1] = parseFloat(
            document.getElementById("matrix-0-1").value
    );
    convMatrix[0][2] = parseFloat(
            document.getElementById("matrix-0-2").value
    );
    convMatrix[1][0] = parseFloat(
            document.getElementById("matrix-1-0").value
    );
    convMatrix[1][1] = parseFloat(
            document.getElementById("matrix-1-1").value
    );
    convMatrix[1][2] = parseFloat(
            document.getElementById("matrix-1-2").value
    );
    convMatrix[2][0] = parseFloat(
            document.getElementById("matrix-2-0").value
    );
    convMatrix[2][1] = parseFloat(
            document.getElementById("matrix-2-1").value
    );
    convMatrix[2][2] = parseFloat(
            document.getElementById("matrix-2-2").value
    );
    //IF EMPTY MATRIX IS ENTERED THIS GIVES IDENTITY
    if (Number.isNaN(convMatrix[0][0])) {
      convMatrix = [
        [0, 0, 0],
        [0, 1, 0],
        [0, 0, 0],
      ];
    }

    //ACTUAL CONVOLUTIONS HAPPENING
    for (let i = 0; i < iterations; i++) {
      //ADDING PADDING
      let size = finMatrix[0].length;
      const zerosArray = new Array(size).fill(0);
      finMatrix.unshift(zerosArray);
      finMatrix.push(zerosArray);
      finMatrix = finMatrix.map((row) => [0, ...row, 0]);
      finMatrix = convolution2D(finMatrix, convMatrix);
    }
    let canvas = document.createElement("canvas");
    let canvasDiv = document.getElementById("output-canvas");
    canvasDiv.innerHTML = "";
    canvas.width = finMatrix[0].length;
    canvas.height = finMatrix.length;
    canvasDiv.appendChild(canvas);

    let context = canvas.getContext("2d");
    let finImgData = context.createImageData(canvas.width, canvas.height);

    for (let y = 0; y < finMatrix.length; y++) {
      for (let x = 0; x < finMatrix[0].length; x++) {
        const index = 4 * (x + y * finMatrix[0].length);
        finImgData.data[index] = finMatrix[y][x];
        finImgData.data[index + 1] = finMatrix[y][x];
        finImgData.data[index + 2] = finMatrix[y][x];
        finImgData.data[index + 3] = 255;
      }
    }
    context.putImageData(finImgData, 0, 0);
    const saveButton = document.getElementById("save-button");
    saveButton.addEventListener("click", () => {
      const dataURL = canvas.toDataURL("image/png"); // convert canvas content to data URL
      const downloadLink = document.createElement("a"); // create a new download link
      downloadLink.href = dataURL; // set the href of the link to the data URL
      downloadLink.download = "convolutedImage.png"; // set the download filename
      document.body.appendChild(downloadLink); // append the link to the document body
      downloadLink.click(); // simulate a click on the link to trigger the download
      document.body.removeChild(downloadLink); // remove the link from the document body
    });
  });
</script>
<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous"
></script>
<script
        src="https://kit.fontawesome.com/c5b250e284.js"
        crossorigin="anonymous"
></script>

</body>
</html>

